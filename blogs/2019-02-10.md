
# No.19001 *2019-02-10 Docker Swarm 和 Portainer 演示环境搭建*

# Docker Swarm 和 Portainer 演示环境搭建指南

## 设置演示环境的主机信息

使用 *hostnamectl* 命令设置主机名称信息

```bash
hostnamectl --transient set-hostname centos-node-40
hostnamectl --transient set-hostname centos-node-41
hostnamectl --transient set-hostname centos-node-42
```

## 在演示环境主机中安装Docker 以及相关的依赖库等  

切换到 */opt* 目录，使用 *vi ./init.sh* 命令,

*init.sh* 的内容详细见附件init.sh

## 初始化swarm 集群信息

[Docker swarm 文档]( https://docs.docker.com/engine/reference/commandline/swarm_init/)

> 详细使用参见 https://docs.docker.com/engine/reference/commandline/swarm_init/ 

在 4.40 主机输入以下信息

```bash

docker swarm init --advertise-addr 172.19.4.40  
Swarm initialized: current node (lap9i1i1ke9frh2nqh5b0ff0n) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-2ntvtbznn7z7c9imlbl9x3k48ywqzmpx9og3xybzoqcd39vj7r-33mdjg2ud4vn9aofavkyiebrc 172.19.4.40:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

```

```bash
docker swarm init --advertise-addr Ip_address --listen-addr ip_address
```

## 在演示环境 安装 portainer 演示环境信息

```bash

$ curl -L https://downloads.portainer.io/portainer-agent-stack.yml -o portainer-agent-stack.yml
.....
$ docker stack deploy --compose-file=portainer-agent-stack.yml portainer

```

[更多portainer使用文档](https://portainer.readthedocs.io/en/latest/deployment.html#inside-a-swarm-cluster)

演示环境通过*'ip:9000'*访问 portainer

[portainer ui](http://124.133.33.114:3102)

admin/mass2019

172.19.4.40:9000

## Docker Swarm 共享数据卷的问题讨论

Portainer也存在同样的问题，因为它将数据保存在卷上的sqlite中，如果Portainer运行它的管理器发生了某些事情，它将在另一个管理器上重新启动。

我想写一些关于利用它的后续行动。简而言之，有2.5种方法可以解决这个问题（一种是通过Docker / Swarm本身以外的方式，所以它就像1/2）：第一种是通过将具有持久性卷的资源锁定到特定节点，第二种是通过使用卷插件来实现利用外部存储资源，第三是通过运行带有DB的2个容器并在它们之间设置复制（而不是使设置过于复杂）。

实际上，从我到目前为止在处理数据库和容器运行方面看到的最好（性能和设置方面）是在容器之外运行数据库并在那里设置适当的HA（复制+自动故障转移），然后允许你的应用程序连接到DB。

这些是传统RDBMS的选项。如果我们谈论其他数据库，例如NoSQL或其他数据存储引擎，那些可能在Docker集群中更好地工作，因为它们中的大多数支持简单的水平扩展，并且开箱即用的数据复制（例如Cassandra，CouchDB，MongoDB，HDFS）等等）。

我觉得这项技术仍然有点太新，无法轻松解决有状态应用程序的问题。但我相信它会到达那里。

[https://www.reddit.com/r/docker/comments/a9qfr9/docker_swarm_ha_setup_for_production/](https://www.reddit.com/r/docker/comments/a9qfr9/docker_swarm_ha_setup_for_production/)

-----

### 其他信息

Linux查看端口占用情况命令

查看80端口占用情况使用如下命令：

```bash
lsof -i tcp:80
```

列出所有端口

```bash
netstat -ntlp
```

-----
