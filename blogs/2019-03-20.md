# Docker 最佳实践系列  HA MariaDB服务

-----

## 在docker swarm环境中部署 HA MariaDB服务

H/A MariaDB Cluster on Docker Swarm

[英文原文:](https://hub.docker.com/r/bitnami/mariadb)

### 1. 准备工作

获取部署文件

``` yml
version: '3'

services:
  mariadb-master:
    image: 'bitnami/mariadb:10.1.38'
    ports:
      - '3306:3306'
    volumes:
      - mysql_data:/bitnami/mariadb
    environment:
      - MARIADB_REPLICATION_MODE=master
      - MARIADB_REPLICATION_USER=repl_user
      - MARIADB_REPLICATION_PASSWORD=repl_password
      - MARIADB_ROOT_PASSWORD=master_root_password
      - MARIADB_USER=my_user
      - MARIADB_PASSWORD=my_password
      - MARIADB_DATABASE=my_database
  mariadb-slave:
    image: 'bitnami/mariadb:10.1.38'
    ports:
      - '3306:3306'
    depends_on:
      - mariadb-master
    environment:
      - MARIADB_REPLICATION_MODE=slave
      - MARIADB_REPLICATION_USER=repl_user
      - MARIADB_REPLICATION_PASSWORD=repl_password
      - MARIADB_MASTER_HOST=mariadb-master
      - MARIADB_MASTER_PORT_NUMBER=3306
      - MARIADB_MASTER_ROOT_PASSWORD=master_root_password
    volumes:
      - mysql_data1:/bitnami/mariadb

volumes:
  mysql_data:
  mysql_data1:

```

### 2. 部署

使用部署命令或portainer 部署

``` bash
docker stack deploy -c mariadb.yml mariadb  
```

### 3. bitnami Mysql 配置文件信息

初始化信息
容器第一次执行时候, 自动执行/docker-entrypoint-initdb.d目录下的 .sh, .sql and .sql.gz 格式文件.

用户名和密码

- MARIADB_ROOT_USER: 管理员用户. 默认为 root.
- MARIADB_ROOT_PASSWORD: 管理员密码. 没有默认值.

>注意： The MARIADB_ROOT_USER 用户默认具备远程访问权限. 建议使用 MARIADB_ROOT_PASSWORD 环境变量为 MARIADB_ROOT_USER 用户指定密码. 使用环境变量ALLOW_EMPTY_PASSWORD=yes 可以为管理员设置空密码，但只建议在开发环境中这样使用

配置文件
用户自定义的配置文件路径为 /opt/bitnami/mariadb/conf/my_custom.cnf. 创建一个文件为 my_custom.cnf 并挂载到 /opt/bitnami/mariadb/conf/my_custom.cnf.

例如，用下面的my_custom.cnf.来设置 max_allowed_packet :

``` cnf
[mysqld]
max_allowed_packet=32M

```

在docker-compose.yml中设置

``` yml
    volumes:
      - /path/to/my_custom.cnf:/opt/bitnami/mariadb/conf/my_custom.cnf:ro
      - /path/to/mariadb-persistence:/bitnami/mariadb
```

日志
默认日志为 stdout

备份存储卷快照 /path/to/mariadb-persistence:

``` bash
rsync -a /path/to/mariadb-persistence /path/to/mariadb-persistence.bkp.$(date +%Y%m%d-%H.%M.%S)
```

环境变量信息

| Environment   |      Variable      |  Alias |
