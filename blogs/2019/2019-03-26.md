# Spring Cloud 系列  Spring Security OAuth2 and Resource Server with JSON Web Token (JWT)

Posted on December 27, 2018 | Last updated January 3, 2019

## 构建自己的 OAuth2 Server

这篇文章介绍使用Spring 框架构建 OAuth2 and Resource Server  。

[出处](https://codeaches.com/blog/jwt-spring-security-oauth2-and-resource-server/)

[GitHub代码](https://github.com/codeaches/jwt-oauth2-and-resource-servers)

-----

### 前言

 The Spring OAuth 2.0 Authorization mechanism manages and verifies the OAuth 2.0 tokens which are used to access the protected resources. The requests for the tokens are handled by Spring MVC controller endpoints.

在本教程中,构建一个 OAuth 2.0 Authorization 服务器并使用一个 jwtpetstore 服务来作为我们要保护的资源服务器.

内容提纲：

- 准备工作
- 构建 authorization server
- 测试 authorization server
- 构建资源服务器
- 测试资源服务器
- 总结

### 准备工作

I have used Open JDK 11 and Spring Tool Suite 4 IDE for this tutorial. I have not tried with the other versions though.

- Open Source JDK 11
- Spring Tool Suite 4 IDE

### Build authorization server

从使用 Spring Initializr 创建一个 Spring Boot starter 项目开始
让我们使用 spring initializr web 工具，创建一个 spring boot 项目作 Authorization Server. Group 设置为 com.codeaches, Artifact 设置为 jwtoauth2server ，选择以下部件部件作为项目依赖： Web,Security,Cloud OAuth2,H2,JPA . 选择使用 Java 11 版本

点击生成项目. 会提示你下载一个名为 jwtoauth2server.zip 的文件.

另一方面, 你也可以使用以下 cURL shell 命令来生成项目

``` bash
curl https://start.spring.io/starter.zip  \
       -d dependencies=web,cloud-security,cloud-oauth2,h2,data-jpa \
       -d language=java \
       -d javaVersion=11 \
       -d type=maven-project \
       -d groupId=com.codeaches \
       -d artifactId=jwtoauth2server \
       -d bootVersion=2.2.0.BUILD-SNAPSHOT \
       -o jwtoauth2server.zip
```

#### 导入项目并构建项目

将项目作为一个Maven 项目导入到 STS 并执行 Maven 构建.

如果构建出现错误信息 “javax.xml.bind.JAXBException: Implementation of JAXB-API has not been found on module path or classpath” ，增加 jaxb-runtime 依赖。

``` xml
<dependency>
    <groupId>org.glassfish.jaxb</groupId>
    <artifactId>jaxb-runtime</artifactId>
</dependency>
```

#### 增加 JWT 依赖到 OAuth2 Server 项目

``` xml
<dependency>
  <groupId>org.springframework.security</groupId>
  <artifactId>spring-security-jwt</artifactId>
  <version>1.0.9.RELEASE</version>
</dependency>
```

#### 创建数据库表 clients, users 和 groups

让我们通过 DDL script 脚本创建服务启动时存放OAuth2 client details 信息的 H2 数据库需要的数据库表

src/main/resources/schema.sql

``` sql
drop table oauth_client_details if exists;
create table oauth_client_details (
    client_id varchar(256) primary key,
    resource_ids varchar(256),
    client_secret varchar(256),
    scope varchar(256),
    authorized_grant_types varchar(256),
    web_server_redirect_uri varchar(256),
    authorities varchar(256),
    access_token_validity integer,
    refresh_token_validity integer,
    additional_information varchar(4096),
    autoapprove varchar(256)
);
```

oauth_client_details 表用来存放客户的短详细信息.

#### 创建一个客户端

让我们在 oauth_client_details 表中创建一条客户端记录信息，客户端名称为 appclient 密码是 appclient@123.

appclient 将对 jwtpetstore 资源具有读和写的访问权限

存到数据库中的密码需要使用Bcrypt 格式加密，可以使用在线工具来 8 rounds 生成/加密密码

src/main/resources/data.sql

``` sql
INSERT INTO
  oauth_client_details (
    client_id,
    client_secret,
    resource_ids,
    scope,
    authorized_grant_types,
    authorities,
    access_token_validity,
    refresh_token_validity
  )
VALUES
  (
    'appclient',
    '$2a$08$ePUWmsLTqNezRk7MCUfg6.HU3RUO3N2M6H.Xj0gMvKiUsGgvg/Fve',
    'petstore',
    'read,write',
    'authorization_code,check_token,refresh_token,password',
    'ROLE_CLIENT',
    2500,
    250000
  );
```

#### 创建表 users, groups, group authorities 和 group members

让我们通过 DDL script 脚本创建服务启动时存放 users  groups 详细信息的 H2 数据库需要的数据库表

src/main/resources/schema.sql

``` sql
drop table users if exists;
create table users(
    username varchar_ignorecase(256) not null primary key,
    password varchar_ignorecase(256) not null,
    enabled boolean not null
);

drop table groups if exists;
create table groups (
    id bigint generated by default as identity(start with 0) primary key,
    group_name varchar_ignorecase(50) not null
);

drop table group_authorities if exists;
create table group_authorities (
    group_id bigint not null,
    authority varchar(50) not null,
    constraint fk_group_authorities_group foreign key(group_id) references groups(id)
);

drop table group_members if exists;
create table group_members (
    id bigint generated by default as identity(start with 0) primary key,
    username varchar(50) not null,
    group_id bigint not null,
    constraint fk_group_members_group foreign key(group_id) references groups(id)
);

```

#### 添加 users, groups, group authorities 和 group members

- 创建一个用户名为john ，其密码为 john@123 ，用户名 kelly 其密码为 kelly@123.
- 创建一个用户组 jwtpetstore_USER_AND_ADMIN_GROUP 并授权 AUTHORIZED_PETSTORE_USER 和 AUTHORIZED_PETSTORE_ADMIN 角色.
- 同时创建用户组 jwtpetstore_USER_ONLY_GROUP 并分配角色 AUTHORIZED_PETSTORE_USER.
- 添加 john 用户到用户组 jwtpetstore_USER_AND_ADMIN_GROUP ，将 kelly 添加到用户组 jwtpetstore_USER_ONLY_GROUP.

> 数据库存放的密码使用 Bcrypt 格式，你可以使用在线工具来生成对应的密码(with 4 rounds).

src/main/resources/data.sql

``` sql
INSERT INTO users (username,password,enabled) 
    VALUES ('john', '$2a$04$Ts1ry6sOr1BXXie5Eez.j.bsvqC0u3x7xAwOInn2qrItwsUUIC9li', TRUE);
INSERT INTO users (username,password,enabled) 
    VALUES ('kelly','$2a$04$qkCGgz.e5dkTiZogvzxla.KXbIvWXrQzyf8wTPJOOJBKjtHAQhoBa', TRUE);
  
INSERT INTO groups (id, group_name) VALUES (1, 'jwtpetstore_USER_AND_ADMIN_GROUP');
INSERT INTO groups (id, group_name) VALUES (2, 'jwtpetstore_USER_ONLY_GROUP');

INSERT INTO group_authorities (group_id, authority) VALUES (1, 'AUTHORIZED_PETSTORE_USER');
INSERT INTO group_authorities (group_id, authority) VALUES (1, 'AUTHORIZED_PETSTORE_ADMIN');

INSERT INTO group_authorities (group_id, authority) VALUES (2, 'AUTHORIZED_PETSTORE_USER');

INSERT INTO group_members (username, group_id) VALUES ('john', 1);
INSERT INTO group_members (username, group_id) VALUES ('kelly', 2);
```

#### 配置 OAuth2 Server

创建类 AuthServerConfig.java 并使用注解 @EnableAuthorizationServer. 这个注解表明Spring 会使用内置的 OAuth 2.0 Authorization Server mechanism 机制来配置项目

- JwtAccessTokenConverter 是一个工具类/帮助类 ，实现 JWT encoded token values 和 OAuth authentication 身份验证信息的转换 (双向转换).当tokens被授权后 它也担当 TokenEnhancer 作用.
- BCryptPasswordEncoder 实现 PasswordEncoder 使用 BCrypt strong hashing 函数.客户端可以选择提供“强度”（也就是BCrypt中的日志轮次 log rounds）和 SecureRandom 实例(SecureRandom instance).强度参数越大，散列密码的工作量（指数式）就越多. 此示例中 client secret 使用的值为8.
- AuthorizationServerEndpointsConfigurer 配置Authorization Server端点的非安全功能(non-security), 如 token store, token customizations, user approvals and grant types.
- AuthorizationServerSecurityConfigurer 配置Authorization Server 的安全性，实际上意味着 /oauth/token 端点.
- ClientDetailsServiceConfigurer 配置ClientDetailsS​​ervice，例如声明 独立的客户端及其属性.

com.codeaches.jwtoauth2server.AuthServerConfig.java

``` java
@Configuration
@EnableAuthorizationServer
public class AuthServerConfig extends AuthorizationServerConfigurerAdapter {

    @Autowired
    DataSource ds;

    @Autowired
    AuthenticationManager authMgr;

    @Autowired
    private UserDetailsService usrSvc;

    @Bean("clientPasswordEncoder")
    PasswordEncoder clientPasswordEncoder() {
        return new BCryptPasswordEncoder(8);
    }

    @Bean
    JwtAccessTokenConverter jwtAccessTokenConverter() {
        JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
        converter.setSigningKey("JWTKey@123");
        return converter;
    }

    @Override
    public void configure(AuthorizationServerSecurityConfigurer cfg) throws Exception {

        // Enable /oauth/token_key URL used by resource server to validate JWT tokens
        cfg.tokenKeyAccess("permitAll");

        // Enable /oauth/check_token URL
        cfg.checkTokenAccess("permitAll");

        // BCryptPasswordEncoder(8) is used for oauth_client_details.user_secret
        cfg.passwordEncoder(clientPasswordEncoder());
    }

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        clients.jdbc(ds);
    }

    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {

        endpoints.accessTokenConverter(jwtAccessTokenConverter());
        endpoints.authenticationManager(authMgr);
        endpoints.userDetailsService(usrSvc);
    }
}
```

#### 配置用户安全认证

让我们创建一个类UserSecurityConfig.java来处理用户身份验证。

- setEnableAuthorities(false)禁用权限表的使用，并setEnableGroups(true)启用组，组权限和组成员表的使用。
- BCryptPasswordEncoder实现使用BCrypt强哈希函数的PasswordEncoder。客户端可以选择提供“强度”（也就是BCrypt中的日志轮次）和SecureRandom实例。强度参数越大，散列密码的工作量（指数式）就越多。此示例中使用的值为4user's password

com.codeaches.jwtoauth2server.UserSecurityConfig.java

``` java
@Configuration
public class UserSecurityConfig extends WebSecurityConfigurerAdapter {

    @Autowired
    DataSource ds;

    @Override
    @Bean(BeanIds.USER_DETAILS_SERVICE)
    public UserDetailsService userDetailsServiceBean() throws Exception {
        return super.userDetailsServiceBean();
    }

    @Override
    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    @Bean("userPasswordEncoder")
    PasswordEncoder userPasswordEncoder() {
        return new BCryptPasswordEncoder(4);
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {

        // BCryptPasswordEncoder(4) is used for users.password column
        JdbcUserDetailsManagerConfigurer<AuthenticationManagerBuilder> cfg = auth.jdbcAuthentication()
                .passwordEncoder(userPasswordEncoder()).dataSource(ds);

        cfg.getUserDetailsService().setEnableGroups(true);
        cfg.getUserDetailsService().setEnableAuthorities(false);
    }
}
```

#### 配置jwtoauth2server项目 在端口9051上运行

src/main/resources/application.properties

``` properties
server.port=9051
```

#### 启动OAuth2服务器

运行jwtoauth2server应用程序Spring Boot App并确保服务器已在端口上成功启动9051

``` bash
...
TomcatWebServer  : Tomcat started on port(s): 9051 (http) with context path ''
DemoApplication  : Started DemoApplication in 12.233 seconds (JVM running for 14.419)
...
```

### 测试授权服务器

现在我们已jwtoauth2server启动并运行应用程序，让我们通过提交几个POST调用来测试应用程序。

#### 获得一个令牌

让我们从OAuth2 Server 获取一个令牌，用于kelly使用URI /oauth/token和grant_type=password

>请求

``` bash
curl -X POST http://localhost:9051/oauth/token \
    --header "Authorization:Basic YXBwY2xpZW50OmFwcGNsaWVudEAxMjM=" \
    -d "grant_type=password" \
    -d "username=kelly" \
    -d "password=kelly@123"
```

> YXBwY2xpZW50OmFwcGNsaWVudEAxMjM= 是client_id和client_secret的Base 64授权版本(appclient:appclient@123)。

响应

``` json
{  
   "access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNTQ2MDAyNzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.5F-tS2vPWfejwwcEWxhA2MprQuu3H-A_56gcj6NS_iw",
   "token_type":"bearer",
   "refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiYXRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiZXhwIjoxNTQ2NDc3NzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiMDdhMmZkYjgtZTc4My00NzQwLWEwY2MtOTNmYTFkYTgxNmMzIiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.KCzK75yBi34wy2bPQAuYmzEuECJFRRp9mnULh_59GpU",
   "expires_in":24999,
   "scope":"read write",
   "jti":"df76986d-651b-43c2-9392-0a5c22f93c38"
}
```

#### 验证access_token

让我们通过使用URI调用OAuth2 Server来验证上面检索的access_token 
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNTQ2MDAyNzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.5F-tS2vPWfejwwcEWxhA2MprQuu3H-A_56gcj6NS_iw/oauth/check_token

请求

``` bash
curl -X POST http://localhost:9051/oauth/check_token \
    -d "token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNTQ2MDAyNzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.5F-tS2vPWfejwwcEWxhA2MprQuu3H-A_56gcj6NS_iw"
```

响应

``` json
{  
   "aud":[  
      "jwtpetstore"
   ],
   "user_name":"kelly",
   "scope":[  
      "read",
      "write"
   ],
   "active":true,
   "exp":1546002713,
   "authorities":[  
      "AUTHORIZED_PETSTORE_USER"
   ],
   "jti":"df76986d-651b-43c2-9392-0a5c22f93c38",
   "client_id":"appclient"
}
```

#### 使用先前获得的刷新令牌获取新令牌

让我们通过使用获得的早先得到的OAuth2服务器一个新的令牌refresh_token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiYXRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiZXhwIjoxNTQ2NDc3NzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiMDdhMmZkYjgtZTc4My00NzQwLWEwY2MtOTNmYTFkYTgxNmMzIiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.KCzK75yBi34wy2bPQAuYmzEuECJFRRp9mnULh_59GpU使用URI /oauth/token和grant_type=refresh_token

请求

``` bash
curl -X POST http://localhost:9051/oauth/token \
    --header "Authorization:Basic YXBwY2xpZW50OmFwcGNsaWVudEAxMjM=" \
    -d "grant_type=refresh_token" \
    -d "refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiYXRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiZXhwIjoxNTQ2NDc3NzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiMDdhMmZkYjgtZTc4My00NzQwLWEwY2MtOTNmYTFkYTgxNmMzIiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.KCzK75yBi34wy2bPQAuYmzEuECJFRRp9mnULh_59GpU"
```

响应

``` json
{  
   "access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNTQ2MDAzMDg1LCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiOGE3NTE2Y2ItNGFmMy00YTRkLWFiMWYtMTA1ZThkNmFkMWRhIiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.S90V46jEHyE8czzsP0WCRu3lnPH0fz5ooZRf6YXZ670",
   "token_type":"bearer",
   "refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiYXRpIjoiOGE3NTE2Y2ItNGFmMy00YTRkLWFiMWYtMTA1ZThkNmFkMWRhIiwiZXhwIjoxNTQ2NDc3NzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiMDdhMmZkYjgtZTc4My00NzQwLWEwY2MtOTNmYTFkYTgxNmMzIiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.hrvyQglaeL1PBHCuZUOtJrIQQzVr9l8JeaR3y0w25pU",
   "expires_in":24999,
   "scope":"read write",
   "jti":"8a7516cb-4af3-4a4d-ab1f-105e8d6ad1da"
}
```

### 构建资源服务器

让我们创建一个名为jwtpetstore的Spring Boot REST服务，并公开几个端点。这将是我们的资源服务器。

#### 使用Spring Initializr创建Spring Boot启动项目

让我们使用[spring initializr web工具](https://start.spring.io/)，为jwtpetstore资源服务器创建一个启动项目框架。更新Group field com.codeaches，Artifact 为 jwtpetstore ，选择Web，Security，Cloud OAuth2 依赖。选择Java版本为11

点击 Generate Project。该项目将作为jwtpetstore.zip文件下载到您的硬盘上。

或者，您也可以使用cURL在shell中生成项目

``` bash
curl https://start.spring.io/starter.zip  \
       -d dependencies=web,cloud-security,cloud-oauth2 \
       -d language=java \
       -d javaVersion=11 \
       -d type=maven-project \
       -d groupId=com.codeaches \
       -d artifactId=jwtpetstore \
       -d bootVersion=2.2.0.BUILD-SNAPSHOT \
       -o jwtpetstore.zip
```

#### 导入和构建项目

在STS中以Existing Maven project 导入项目，然后执行Maven构建。

如果构建失败并添加错误“javax.xml.bind.JAXBException：在模块路径或类路径上找不到JAXB-API的实现”，则添加jaxb-runtime依赖性

``` xml
<dependency>
    <groupId>org.glassfish.jaxb</groupId>
    <artifactId>jaxb-runtime</artifactId>
</dependency>
```

#### 配置jwtpetstore项目以在端口8011上运行

src/main/resources/application.properties

``` properties
server.port=8011
```

#### 在jwtpetstore应用程序上启用资源服务器机制

我们用它来注释DemoApplication.java @EnableResourceServer。Spring内部使用此批注来为项目添加配置资源服务器机制

com.codeaches.jwtpetstore.DemoApplication.java

``` java

@SpringBootApplication
@EnableResourceServer
public class DemoApplication {

    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
}
```

#### 将REST方法添加到jwtpetstore应用程序

让我们创建一个类PetstoreController.java并配置REST方法pet（）和favouritePet（）

/pet可以由属于的用户进行访问，AUTHORIZED_PETSTORE_USER
/favouritePet可以由属于的用户进行访问AUTHORIZED_PETSTORE_ADMIN

com.codeaches.jwtpetstore.PetstoreController.java

``` java
@RestController
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class PetstoreController {

    @GetMapping("pet")
    @PreAuthorize("hasAuthority('AUTHORIZED_PETSTORE_USER')")
    public String pet(Principal principal) {
        return "Hi " + principal.getName() + ". My pet is dog";
    }

    @GetMapping("favouritePet")
    @PreAuthorize("hasAuthority('AUTHORIZED_PETSTORE_ADMIN')")
    public String favouritePet(Principal principal) {
        return "Hi " + principal.getName() + ". My favourite pet is cat";
    }
}
```

>确保添加@EnableGlobalMethodSecurity(prePostEnabled = true)以启用@PreAuthorize检查。

#### 使用Client Credentials和JWT签名密钥配置jwtpetstore应用程序

让我们使用客户端凭据appclient和JWT签名密钥更新jwtpetstore应用程序JWTKey@123

> 请注意，客户端appclient有权访问oauth_client_details表中的jwtpetstore资源。

src/main/resources/application.properties

``` properties
security.oauth2.client.client-id=appclient
security.oauth2.client.client-secret=appclient@123

security.oauth2.resource.id=petstore

security.oauth2.resource.jwt.key-value=JWTKey@123
```

**请注意**，值security.oauth2.resource.jwt.key-value应与OAuth2服务器中提供的签名密钥匹配。请参考AuthServerConfig.javaOAuth2服务器。

> 相反的security.oauth2.resource.jwt.key-value，我们也可配置security.oauth2.resource.jwt.key-uri 为 <http://localhost:9051/oauth/token_key>用于令牌验证。

#### 启动jwtpetstore资源服务器

运行jwtpetstore应用程序Spring Boot App并确保服务器已在端口上成功启动8011

``` bash
...
TomcatWebServer  : Tomcat started on port(s): 8011 (http) with context path ''
DemoApplication  : Started DemoApplication in 12.233 seconds (JVM running for 14.419)
...
```

#### 测试资源服务器

测试访问 /pet 属于的 用户 AUTHORIZED_PETSTORE_USER 都可以访问

john 和 kelly 都有权访问 /pet

Request

``` bash
curl -X GET http://localhost:8011/pet \
    --header "Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNTQ2MDAyNzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.5F-tS2vPWfejwwcEWxhA2MprQuu3H-A_56gcj6NS_iw"
```

eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNTQ2MDAyNzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.5F-tS2vPWfejwwcEWxhA2MprQuu3H-A_56gcj6NS_iw is the access_token obtained from OAuth2 Server for the user kelly.

Response

``` bash
Hi kelly. My pet is dog
```

测试 /favouritePet 属于用户组 AUTHORIZED_PETSTORE_ADMIN 都有权访问

只有 john 具备 /favouritePet 的访问权

Request

``` bash
curl -X GET http://localhost:8011/favouritePet \
    --header "Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsiand0cGV0c3RvcmUiXSwidXNlcl9uYW1lIjoiam9obiIsInNjb3BlIjpbInJlYWQiLCJ3cml0ZSJdLCJleHAiOjE1NDYwMDU0NTksImF1dGhvcml0aWVzIjpbIkFVVEhPUklaRURfUEVUU1RPUkVfQURNSU4iLCJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiN2U0MTZkNzktNjk2NC00MWY2LThmZmEtZTMyMDUxY2UyZGJmIiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.SMccds-h9pbCoyzith1JDJnLjf15mr9AvqKQzzO31S0"
```

eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsiand0cGV0c3RvcmUiXSwidXNlcl9uYW1lIjoiam9obiIsInNjb3BlIjpbInJlYWQiLCJ3cml0ZSJdLCJleHAiOjE1NDYwMDU0NTksImF1dGhvcml0aWVzIjpbIkFVVEhPUklaRURfUEVUU1RPUkVfQURNSU4iLCJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiN2U0MTZkNzktNjk2NC00MWY2LThmZmEtZTMyMDUxY2UyZGJmIiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.SMccds-h9pbCoyzith1JDJnLjf15mr9AvqKQzzO31S0  是OAuth2 Server 中用户john 的访问令牌.

Response

``` bash
Hi john. My favourite pet is cat
```

测试没有 AUTHORIZED_PETSTORE_ADMIN 权限用户对 /favouritePet 的访问

kelly 没有 AUTHORIZED_PETSTORE_ADMIN 权限，她不能正常访问 /favouritePet

Request

``` bash
curl -X GET http://localhost:8011/favouritePet \
    --header "Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicGV0c3RvcmUiXSwidXNlcl9uYW1lIjoia2VsbHkiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNTQ2MDAyNzEzLCJhdXRob3JpdGllcyI6WyJBVVRIT1JJWkVEX1BFVFNUT1JFX1VTRVIiXSwianRpIjoiZGY3Njk4NmQtNjUxYi00M2MyLTkzOTItMGE1YzIyZjkzYzM4IiwiY2xpZW50X2lkIjoiYXBwY2xpZW50In0.5F-tS2vPWfejwwcEWxhA2MprQuu3H-A_56gcj6NS_iw"
```

Response

``` json
{
    "error": "access_denied",
    "error_description": "Access is denied"
}
```

### 总结

恭喜！您刚刚使用JWT令牌创建了Spring Boot OAuth2授权和资源服务器。

-----

