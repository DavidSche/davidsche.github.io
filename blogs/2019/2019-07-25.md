# Docker 19.03.0 GA å‘å¸ƒäº†ï¼Œæœ‰è®¸å¤šä½¿ç”¨çš„æ–°ç‰¹æ€§ï¼Œä¸‹é¢ç®€å•ä»‹ç»å‡ ä¸ªæ–°ç‰¹æ€§

![æ–°ç‰¹æ€§](https://davidsche.github.io/blogs/images/docker-19-03-00.png)

1. æ”¯æŒä¸Šä¸‹æ–‡å¿«é€Ÿåˆ‡æ¢ï¼Œä¸ç”¨SSHå°±å¯ä»¥ç®¡ç†ä¸åŒçš„Docker ç¯å¢ƒ
2. æ”¯æŒRootless ï¼Œåœ¨æ™®é€šç”¨æˆ·ä¸‹è¿è¡Œdocker ï¼Œè®©ä½ çš„å®¹å™¨åº”ç”¨è¿è¡Œæ›´åŠ å®‰å…¨
3. swarm æœåŠ¡æ”¯æŒsysctl å‚æ•°
4. Windows ç¯å¢ƒæ”¯æŒ-device å‚æ•°
5. æ”¯æŒèŠ‚ç‚¹è¿è¡ŒæœåŠ¡å®ä¾‹å‰¯æœ¬ä¸ªæ•°çš„é™åˆ¶
6. Docker CLI API æ”¯æŒ NVIDIA GPUs

![æ–°ç‰¹æ€§](https://davidsche.github.io/blogs/images/docker-19-03-01.png)

-------

## CLI æ”¯æŒåŠ¨æ€ä¸Šä¸‹æ–‡åˆ‡æ¢

CLI å¼•å…¥ä¸€ç»„ context å‘½ä»¤,æ”¯æŒä¸Šä¸‹æ–‡åŠ¨æ€åˆ‡æ¢ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¸‹æ–‡æ¥åˆ‡æ¢ä¸åŒçš„docker é›†ç¾¤ç¯å¢ƒ

ä¿®æ”¹ /usr/lib/systemd/system/docker.service æ–‡ä»¶ï¼Œæ·»åŠ  -H tcp://192.168.9.26:2375 å†…å®¹

``` bash
# ä¿®æ”¹è¿™é‡Œ
#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://192.168.9.26:2375
```

é‡å¯docker æœåŠ¡

``` bash
systemctl daemon-reload && systemctl restart docker
```

### åœ¨Docker CLIæ·»åŠ ä¸Šä¸‹æ–‡

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ·»åŠ é›†ç¾¤ç¯å¢ƒä¸Šä¸‹æ–‡

``` bash
docker context create --docker host=tcp://192.168.9.26:2375 swarm-26
```

åˆ‡æ¢ä¸Šä¸‹æ–‡

``` bash
## docker context ls --format '{{json .Name}}'
"default"
"swarm-26"

# docker context ls
NAME                DESCRIPTION                               DOCKER ENDPOINT               KUBERNETES ENDPOINT   ORCHESTRATOR
default             Current DOCKER_HOST based configuration   unix:///var/run/docker.sock                         swarm
swarm-26 *                                                    tcp://192.168.9.26:2375

# docker context use swarm-26
swarm-26
Current context is now "swarm-26"
...

```

è¿™æ—¶å€™æ‰§è¡Œå‘½ä»¤å’Œåœ¨192.168.9.26ç¯å¢ƒä¸­æ‰§è¡Œå‘½ä»¤æ•ˆæœæ˜¯ä¸€æ ·çš„

``` bash
# docker  node ls 
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
u8jxnjbe85c9p5atawyg8m75e *   efk-node01          Ready               Active              Leader              19.03.0
0pthnwt5am3fibgo750p7ayhp     efk-node02          Ready               Active                                  19.03.0
[root@docker-manager1 redis]# 
[root@docker-manager1 redis]# docker service ls 
ID                  NAME                MODE                REPLICAS            IMAGE                               PORTS
1x7d8agf3lgi        api-demo            replicated          0/0                 192.168.0.1:5000/api-demo:latest   *:3333->9090/tcp
gfwz8m3ip4s1        es_elasticsearch    replicated          1/1                 bitnami/elasticsearch:7             *:9200->9200/tcp
y0npvs5fh52o        es_kibana           replicated          1/1                 bitnami/kibana:7                    *:5602->5601/tcp
yjzal0gisqds        zipkin_zipkin       replicated          1/1                 openzipkin/zipkin:latest            *:9411->9411/tcp
```

é€šè¿‡ docker context use default å‘½ä»¤å†æ¬¡åˆ‡æ¢å›é»˜è®¤çš„ä¸Šä¸‹æ–‡

æŸ¥çœ‹ä¸Šä¸‹æ–‡å†…å®¹å‘½ä»¤

``` bash
#  docker context inspect swarm-26
[
    {
        "Name": "swarm-26",
        "Metadata": {},
        "Endpoints": {
            "docker": {
                "Host": "tcp://192.168.9.26:2375",
                "SkipTLSVerify": false
            }
        },
        "TLSMaterial": {},
        "Storage": {
            "MetadataPath": "/root/.docker/contexts/meta/7e2a1272a6fba51e688357e3cbd23940e619a3e83ac2eb9a9b35486d9b3f5309",
            "TLSPath": "/root/.docker/contexts/tls/7e2a1272a6fba51e688357e3cbd23940e619a3e83ac2eb9a9b35486d9b3f5309"
        }
    }
]

```

-------

[å‚è€ƒ](http://collabnix.com/docker-19-03-0-fast-context-switching-rootless-docker-sysctl-support-for-swarm-services/)

-------

### Docker Swarm Cluster æ”¯æŒ Sysctl å‚æ•°

å¯¹äºes redis è¿™ç±»åº”ç”¨æ¥è¯´ï¼Œå¼•å…¥ Sysctl æ”¯æŒï¼Œæ–¹ä¾¿è®¾ç½®å†…æ ¸å‚æ•° ï¼Œ

``` yaml
sysctls:
  net.core.somaxconn: 1024
  net.ipv4.tcp_syncookies: 0

sysctls:
  - net.core.somaxconn=1024
  - net.ipv4.tcp_syncookies=0
```

ä¸‹é¢ä»¥ redis ä¸ºä¾‹ä»‹ç»ä¸€ä¸‹ Sysctl çš„ä½¿ç”¨

åœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªredis

éƒ¨ç½²è„šæœ¬

``` yaml
version: '3'
services:
  redis:
    hostname: redis
    image: redis

  redis-commander:
    hostname: redis-commander
    image: rediscommander/redis-commander:latest
    restart: always
    environment:
    - REDIS_HOSTS=local:redis:6379
    ports:
    - "8081:8081"
```

éƒ¨ç½²å‘½ä»¤

``` bash
sudo docker stack deploy -c docker-compose.yml myapp
```

éªŒè¯æœåŠ¡

``` bash
$ sudo docker stack ls
NAME                SERVICES            ORCHESTRATOR
myapp               2                   Swarm

$ sudo docker service ls
ID                  NAME                    MODE                REPLICAS            IMAGE                                   PORTS
ucakpqi7ozg1        myapp_redis             replicated          1/1                 redis:latest
fxor8v90a4m0        myapp_redis-commander   replicated          0/1                 rediscommander/redis-commander:latest   *:8081->8081/tcp
```

æŸ¥çœ‹æ—¥å¿—

``` bash
$ docker service logs -f myapp3_redis
myapp3_redis.1.7jpnbigi8kek@manager1    | 1:C 17 Apr 2019 06:26:08.006 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
myapp3_redis.1.7jpnbigi8kek@manager1    | 1:C 17 Apr 2019 06:26:08.006 # Redis version=5.0.4, bits=64, commit=00000000, modified=0, pid=1, just started
myapp3_redis.1.7jpnbigi8kek@manager1    | 1:C 17 Apr 2019 06:26:08.006 # Warning: no config file specified, using the default config. In order to specify a configfile use redis-server /path/to/redis.conf
myapp3_redis.1.7jpnbigi8kek@manager1    | 1:M 17 Apr 2019 06:26:08.009 * Running mode=standalone, port=6379.
myapp3_redis.1.7jpnbigi8kek@manager1    | 1:M 17 Apr 2019 06:26:08.009 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
```

æ”¹è¿›åçš„éƒ¨ç½²è„šæœ¬ï¼Œå¼•å…¥sysctlså‚æ•°

``` yaml
version: '3'
services:
  redis:
    hostname: redis
    image: redis
  sysctls:
    net.core.somaxconn: 1024
  redis-commander:
    image: rediscommander/redis-commander:latest
    restart: always
    environment:
    - REDIS_HOSTS=local:redis:6379
    ports:
    - "8081:8081"
```

ç›®å‰ç»è¿‡æµ‹è¯• redisä¸­éœ€è¦çš„å‚æ•°åªæ”¯æŒ sys.net.core.somaxconn
    #- sys.net.core.somaxconn=511
    #- vm.overcommit_memory=1
    #- sys.kernel.mm.transparent_hugepage.enabled=never

éƒ¨ç½²å‘½ä»¤

``` bash
$ sudo docker stack deploy -c docker-compose.yml myapp
Ignoring unsupported options: restart
Creating network myapp_default
Creating service myapp_redis
Creating service myapp_redis-commander

$ sudo docker service ls
ID                  NAME                    MODE                REPLICAS            IMAGE                                   PORT
2oxhaychob7s        myapp_redis             replicated          1/1                 redis:latest
pjdwti7hkg1q        myapp_redis-commander   replicated          1/1                 rediscommander/redis-commander:latest   *:80->8081/tcp
```

éªŒè¯æ•ˆæœ

``` bash
$ sudo docker service logs -f myapp_redis
myapp_redis.1.mp57syo3okka@swarm-node-1    | 1:C 17 Apr 2019 06:59:44.510 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
myapp_redis.1.mp57syo3okka@swarm-node-1    | 1:C 17 Apr 2019 06:59:44.510 # Redis version=5.0.4, bits=64, commit=00000000, modified=0, pid=1, just started
myapp_redis.1.mp57syo3okka@swarm-node-1    | 1:M 17 Apr 2019 06:59:44.511 * Running mode=standalone, port=6379.
```

vm.swappiness å‚æ•°è§£å†³æ–¹æ¡ˆ

``` bash
#To successfully set vm.swappiness=0 and vm.overcommit_memory=1 use these steps:

#Verify the current values for vm.swappiness and vm.overcommit_memory:

$ sudo sysctl -a |grep 'vm.swapp*\|vm.over*'
#Change the value of vm.swappiness:

$ sudo sysctl vm.swappiness=0
#Change the value of vm.overcommit_memory:

$ sudo sysctl vm.overcommit_memory=1
#Verify the settings have changed two ways:

$ sudo sysctl -a |grep 'vm.swapp*\|vm.over*'
#Also check the /proc/sys/vm file:

$ cat /proc/sys/vm/overcommit_memory
$ cat /proc/sys/vm/swappiness

```

[docker-link](https://success.docker.com/article/node-using-swap-memory-instead-of-host-memory)

[redis-admin-doc](https://redis.io/topics/admin)

-------

### èŠ‚ç‚¹åˆ—è¡¨æ“ä½œæ”¯æŒä½¿ç”¨ label è¿›è¡Œè¿‡æ»¤

 
To be discussed (either keep the old behavior and ignore node-labels, or filter by both);

``` bash
docker node ls --filter label=foo

#Filter by engine labels:

docker node ls --filter engine.label=foo

#Filter by node label:

docker node ls --filter node.label=foo
```

``` bash
# filter swarm/node labels
$ docker node ls --filter node.label=â€¦
# filter engine labels
$ docker node ls --filter engine.label=â€¦
# filter both labels
$ docker node ls --filter label=â€¦
```

### æ”¯æŒæœåŠ¡è¿è¡Œæ—¶æ¯å°ä¸»æœºçš„è¿è¡Œå®ä¾‹çº¦æŸï¼Œå¯ä»¥çº¦æŸæ¯ä¸ªèŠ‚ç‚¹è¿è¡ŒæœåŠ¡å®ä¾‹çš„æœ€å¤§æ•°ç›®

Gave this a spin, and all looks good ğŸ˜„

We could add some more tests based on the scenarios below, but I'm ok to keep that for a follow-up.

``` bash
#Create a service with max 2 replicas:

docker service create --replicas=2 --replicas-max-per-node=2 --name test nginx:alpine
docker service inspect --format '{{.Spec.TaskTemplate.Placement.MaxReplicas}}' test
2
#Update the service (max replicas should keep its value) - this works ok;

docker service update --replicas=1 test
docker service inspect --format '{{.Spec.TaskTemplate.Placement.MaxReplicas}}' test
2
#Update the max replicas to 1

docker service update --replicas-max-per-node=1 test
docker service inspect --format '{{.Spec.TaskTemplate.Placement.MaxReplicas}}' test
1
#And reset to 0:

docker service update --replicas-max-per-node=0 test
docker service inspect --format '{{.Spec.TaskTemplate.Placement.MaxReplicas}}' test
0
```

[bug](https://github.com/docker/cli/pull/1612)

CPU å†…å­˜  èµ„æºé™åˆ¶

``` bash
docker run -it --memory=2G --cpus=8 alpine sh -c "nproc && cat /proc/meminfo"
```

-------

### Docker-Swarmè°ƒåº¦ç­–ç•¥

2016å¹´06æœˆ01æ—¥ 00:39:51 gezhonglei2007 é˜…è¯»æ•° 3926
swarmåœ¨ç”¨å‘½ä»¤swarm managerå¯åŠ¨swarm manageræ—¶ï¼Œå¯ç”¨--strategyæŒ‡å®šè°ƒåº¦ç­–ç•¥ã€‚ 
swarmæä¾›äº†ä¸‰ç§è°ƒåº¦ç­–ç•¥è®¡ç®—èŠ‚ç‚¹çš„æ’åï¼Œåœ¨è°ƒåº¦ï¼ˆä¾‹å¦‚é€‰æ‹©å“ªä¸€ä¸ªèŠ‚ç‚¹è¿è¡Œå®¹å™¨æ—¶ï¼‰æ—¶ï¼Œå–æ’åæœ€å‰çš„èŠ‚ç‚¹ã€‚

è¿™ä¸‰ç§è°ƒåº¦ç­–ç•¥æ˜¯ï¼š 
- spread 
- binpack 
- random

randomç­–ç•¥ï¼šéšæœºé€‰æ‹©èŠ‚ç‚¹ã€‚ä¸€èˆ¬ç”¨äºå¼€å‘æµ‹è¯•é˜¶æ®µã€‚

spreadç­–ç•¥ï¼šé»˜è®¤ç­–ç•¥ï¼Œswarmä¼˜å…ˆé€‰æ‹©å ç”¨èµ„æºï¼ˆå¦‚CPUã€å†…å­˜ç­‰ï¼‰æœ€å°‘çš„èŠ‚ç‚¹ï¼Œèƒ½ä¿è¯é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹èµ„æºçš„å‡åŒ€ä½¿ç”¨ã€‚ 
å®ƒçš„å¥½å¤„æ˜¯ï¼Œä¿è¯

binpackç­–ç•¥ï¼šä¸spreadç›¸åï¼Œå®ƒçš„ç›®çš„æ˜¯å°½å¯èƒ½åœ°å¡«æ»¡ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»¥ä¿è¯æ›´å¤šç©ºä½™çš„èŠ‚ç‚¹ã€‚

ç¤ºä¾‹ï¼š

# æµ‹è¯•spreadç­–ç•¥
# èƒŒæ™¯ï¼šswarmé›†ç¾¤ä¸­æœ‰ä¸¤ä¸ªç›¸åŒèµ„æºï¼ˆcpuã€å†…å­˜å¤§å°ç›¸åŒï¼‰çš„èŠ‚ç‚¹node1 node2
# è¿è¡Œä¸¤ä¸ªå®¹å™¨
docker tcp://<manager_ip:manager_port> run -d -P -m 1G --name db mysql
docker tcp://<manager_ip:manager_port> run -d -P -m 1G --name db mysql
# æŸ¥çœ‹å®¹å™¨æ‰€åœ¨èŠ‚ç‚¹
docker tcp://<manager_ip:manager_port> ps
# ç»“æœåˆ†æï¼šå¦‚æœæ˜¯spreadç­–ç•¥ï¼Œä¸¤ä¸ªè¿è¡Œçš„å®¹å™¨ä¸€å®šåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸²
#       å¦‚æœæ˜¯binpackç­–ç•¥ï¼Œä¸¤ä¸ªè¿è¡Œçš„å®¹å™¨ä¸€å®šåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸­

å‚è€ƒï¼šhttps://docs.docker.com/swarm/scheduler/strategy/


### Docker Swarm è´Ÿè½½å‡è¡¡æ¨¡å¼é€‰æ‹©

è´Ÿè½½å‡è¡¡æœ‰ä¸¤ç§æ¨¡å¼ï¼šVIPã€DNSRR

VIPï¼šåˆ†é…ç‹¬ç«‹çš„è™šæ‹ŸIPï¼ŒDNSè®°å½•è§£æåˆ°æœåŠ¡åä¸­ä½œä¸ºä»£ç†IPã€‚
dnsrrï¼šDNSè®°å½•ä¸è§£æVIPï¼Œè€Œå»è§£ææ¯ä¸ªå®¹å™¨å†…çš„IPã€‚dnsrræ¨¡å¼ä¸æ”¯æŒç«¯å£å¯¹å¤–æš´éœ²ã€‚
1ã€ç®¡ç†èŠ‚ç‚¹ï¼šé€šè¿‡æŸ¥çœ‹æœåŠ¡è¯¦ç»†ä¿¡æ¯ç­›é€‰å½“å‰æ¨¡å¼è´Ÿè½½å‡è¡¡æ¨¡å¼
docker service inspect my_web

æ³¨ï¼šå½“å‰æ¨¡å¼ä¸ºVIPæ¨¡å¼ã€‚

2ã€ç®¡ç†èŠ‚ç‚¹ï¼šè®¾ç½®DNSè½®è¯¢æ¨¡å¼

```

docker service create \
--replicas 3 \
--name my-web \
--network my-network \
--endpoint-mode dnsrr \
nginx
```
3ç®¡ç†èŠ‚ç‚¹ï¼šåˆ›å»ºä¸€ä¸ªæµ‹è¯•å®¹å™¨my_web2

```
docker service create --replicas 3 --network my-network --name my_web2 nginx 
```

4ã€ç®¡ç†èŠ‚ç‚¹ï¼šæ·»åŠ dnsrræ¨¡å¼

```
docker service update --endpoint-mode dnsrr my_web2 
```
5ã€å·¥ä½œèŠ‚ç‚¹ï¼šè¿›å…¥å®¹å™¨æµ‹è¯•

```
docker exec -it 06a5a7ae6e7e sh
```
