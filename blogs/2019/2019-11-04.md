# Deploy GitLab CE on Docker Swarm

[è‹±æ–‡åŸæ–‡](https://lunar.computer/posts/gitlab-docker-swarm/)

## **å‰è¨€**

è¿™ä¸ªç®€çŸ­çš„æ•™ç¨‹ä»¥GitLab CE ä¸ºä¾‹ä»‹ç»äº†å†dockersswarmé›†ç¾¤ç¯å¢ƒä¸­å¦‚ä½•éƒ¨ç½²ä¸€ä¸ªåº”ç”¨.

GitLab CE å¯ä»¥ç›´æ¥å®‰è£…å¹¶è¿è¡Œåœ¨ç‰©ç†æœåŠ¡å™¨ä¸Š.

å‰ææ¡ä»¶ï¼šæ­å»ºå¥½å¹¶è¿è¡Œä¸€ä¸ª Docker Swarm é›†ç¾¤, å¹¶æ‹¥æœ‰ä»¥ç®¡ç†å‘˜ root èº«ä»½è®¿é—®é›†ç¾¤çš„èŠ‚ç‚¹.

## **å‡†å¤‡ç®¡ç†èŠ‚ç‚¹**

é¦–å…ˆç¡®è®¤è¿è¡Œæ‰€éœ€è¦çš„ç¡¬ä»¶èµ„æº. The GitLab CE æ–‡æ¡£å†™æ˜äº†ç‘å•Šæ‰€ç¤ºçš„è¿è¡Œå®ƒçš„æœ€ä½ç¡¬ä»¶è§„æ ¼:

- 1 CPU (up to 100 users)
- 1GB RAM + 3GB Swap (absolute minimum, GitLab recommends 4GB RAM)

å‡å¦‚è¿˜è¦åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œå…¶ä»–çš„åº”ç”¨æœåŠ¡ï¼Œå°±éœ€è¦æ›´å¼ºçš„ç¡¬ä»¶é…ç½®æ¥ä¿è¯æœ‰è¶³å¤Ÿçš„CPUå’Œå†…å­˜ä¾›ä½ ä½¿ç”¨.

ä¸€æ—¦æœ‰äº†è¿è¡Œæ‰€éœ€è¦çš„èŠ‚ç‚¹ï¼Œé€šè¿‡SSHè¿æ¥åˆ°ç®¡ç†èŠ‚ç‚¹ï¼Œåˆ›å»ºä¸€ä¸ªç›®å½•æ¥å­˜å–GitLab CE è¿è¡Œåç”Ÿæˆçš„æ•°æ®æ–‡ä»¶ï¼ˆæ•°æ®ã€æ—¥å¿—ã€é…ç½®ï¼‰

``` shell
# mkdir -p /var/swarm/gitlab/{data,logs,config}
```

## **é…ç½®  GitLab CE**

é€šè¿‡ä¿®æ”¹ä»¥ä¸‹ yaml æ–‡ä»¶æ¥é…ç½® GitLab CE  (é»˜è®¤é…ç½®åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½é€‚ç”¨,), ç¡®è®¤ example.com åŒ¹é…ä½ çš„åŸŸå:

``` shell
# vim /var/swarm/gitlab/docker-compose.yml

```

``` yaml

version: "3.6"
services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    ports:
      - "1222:22"
      - "8081:80"
      - "12443:443"
    networks:
      - proxy
    volumes:
      - /var/swarm/gitlab/data/:/var/opt/gitlab
      - /var/swarm/gitlab/logs/:/var/log/gitlab
      - /var/swarm/gitlab/config/:/etc/gitlab
    environment:
      GITLAB_OMNIBUS_CONFIG: "from_file('/omnibus_config.rb')"
    configs:
      - source: gitlab
        target: /omnibus_config.rb
    deploy:
      labels:
        - traefik.enable=true
        - traefik.backend=gitlab
        - traefik.backend.loadbalancer.swarm=true
        - traefik.docker.network=proxy
        - traefik.frontend.rule=Host:gitlab.example.com
        - traefik.port=80
        - traefik.frontend.headers.SSLRedirect=true
        - traefik.frontend.headers.STSSeconds=315360000
        - traefik.frontend.headers.browserXSSFilter=true
        - traefik.frontend.headers.contentTypeNosniff=true
        - traefik.frontend.headers.forceSTSHeader=true
        - traefik.frontend.headers.SSLHost=gitlab.example.com
        - traefik.frontend.headers.STSIncludeSubdomains=true
        - traefik.frontend.headers.STSPreload=true
        - traefik.frontend.headers.frameDeny=true
      placement:
        constraints:
          - node.role == manager
  gitlab-runner:
    image: gitlab/gitlab-runner:alpine
    deploy:
      mode: replicated
      replicas: 4
configs:
  gitlab:
    file: ./gitlab.rb
networks:
  proxy:
    external: true

```

ä¸€æ—¦å®Œæˆè¿™äº›å·¥ä½œ, ä¸ºGitLab CE åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶(ç”¨ä½ çš„åŸŸåæ›¿ä»£ gitlab.example.com ):

``` shell
# vim /var/swarm/gitlab/gitlab.rb

external_url 'https://gitlab.example.com/'
nginx['listen_port'] = 80
nginx['listen_https'] = false
letsencrypt['enable'] = false

```

è¿™äº›è®¾ç½®å°†ç¦ç”¨ HTTPSï¼Œè®©æˆ‘ä»¬åœ¨ GitLAb CE å®ä¾‹ä¸­ä½¿ç”¨åŠ å¯†ï¼Œå› ä¸ºæˆ‘ä»¬åº”è¯¥å·²ç»æ‹¥æœ‰æ¥è‡ª Traefik åå‘ä»£ç†çš„è¯ä¹¦ã€‚å¦‚æœæ‚¨æ²¡æœ‰ï¼Œè¯·éµå¾ªå‰é¢çš„å…¶ä»–æ•™ç¨‹ï¼Œåˆ™éœ€è¦é…ç½® GitLab ä»¥åŒ¹é…æ‚¨çš„è®¾ç½®ã€‚

æœ‰å…³æ›´å¤šé…ç½®é€‰é¡¹ï¼Œè¯·å‚é˜… GitLab CE æ–‡æ¡£ã€‚

## **éƒ¨ç½² GitLab CE**

``` shell
# docker stack deploy gitlab --compose-file /var/swarm/gitlab/docker-compose.yml
```

ä¼šéœ€è¦ä¸€æ®µæ—¶é—´ï¼Œç›´åˆ° GitLab å’Œ GitLab runner å¯åŠ¨ã€‚å¯åŠ¨åï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—® gitlab.example.comï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°è¿™æ ·çš„é¡µé¢ï¼š

GitLab ç¤¾åŒºç‰ˆ

å¼€æºè½¯ä»¶ï¼Œç”¨äºä»£ç åä½œ

ä½¿ç”¨ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ç®¡ç† Git å­˜å‚¨åº“ï¼Œä»¥ç¡®ä¿ä»£ç çš„å®‰å…¨ã€‚æ‰§è¡Œä»£ç è¯„å®¡å¹¶å¢å¼ºä¸åˆå¹¶è¯·æ±‚çš„åä½œã€‚æ¯ä¸ªé¡¹ç›®è¿˜å¯ä»¥æœ‰ä¸€ä¸ªé—®é¢˜è·Ÿè¸ªå™¨å’Œä¸€ä¸ªwikiã€‚

æœ€åä¸€å¥è¯

ç°åœ¨ï¼Œæ‚¨åº”è¯¥åœ¨ Docker Swarm ç¾¤é›†ä¸Šè¿è¡Œ DevOps å¹³å°ï¼ğŸ˜€å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº GitLabã€Gitã€Docker å’Œ Docker Swarm çš„ä¸€äº›ä¹¦ç±å»ºè®®ï¼š

- Mastering GitLab 12: Implement DevOps culture and repository management solutions
- æŒæ¡ GitLab 12ï¼šå®ç° DevOps åŒºåŸŸæ€§å’Œå­˜å‚¨åº“ç®¡ç†è§£å†³æ–¹æ¡ˆ
- Version Control with Git: Powerful tools and techniques for collaborative software development
- ä½¿ç”¨ Git è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼šç”¨äºåä½œè½¯ä»¶å¼€å‘çš„å¼ºå¤§å·¥å…·å’ŒæŠ€æœ¯
- Docker: Up & Running: Shipping Reliable Containers in Production 2nd
- Docker Deep Dive
- æ·±å…¥æµ…å‡ºDocker

æœ€å¥½çš„è¿æ°”ä¸GitLabå’Œä½ çš„DockerSwarmé›†ç¾¤ï¼ğŸ˜€ ğŸ˜Š

-------
