# Create a Docker Swarm Cluster on DigitalOcean

[è‹±æ–‡åŸæ–‡](https://lunar.computer/posts/docker-swarm-digitalocean/)

## **å‰è¨€**

å®Œæˆåçš„é›†ç¾¤å°†åŒ…å«ä»¥ä¸‹ç»„ä»¶:

- 3ä¸ª VMs
- Fedora 30
- Traefik
- HTTPS using Letâ€™s Encrypt
- SwarmPit


## **å‡†å¤‡**

è¯·ç¡®ä¿æ‚¨é¦–å…ˆæ‹¥æœ‰ä¸€ä¸ªåŸŸåã€‚å¦‚æœæ²¡æœ‰ï¼Œä½ å¯ä»¥åœ¨Porkbunæ³¨å†Œä¸€ä¸ªã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨example.comï¼Œå¹¶ä¸”æ‚¨åº”è¯¥å°†å…¶æ›¿æ¢ä¸ºåŸŸåï¼Œæ— è®ºæ‚¨åœ¨å“ªé‡Œæ‰¾åˆ°å®ƒã€‚

æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸‰ä¸ª VMï¼ˆDropletï¼‰ï¼Œæ‰€æœ‰ VM éƒ½è¿è¡Œ Fedora 30ï¼Œå¹¶å¯ç”¨äº†"ä¸“ç”¨ç½‘ç»œ"ã€‚ç¡®ä¿å®ƒä»¬éƒ½ä½äºåŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒä¸­ã€‚å…¶ä¸­ä¸€ä¸ª VM æ˜¯ç®¡ç†è€…ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯å·¥ä½œèŠ‚ç‚¹ã€‚

ç™»å½•åˆ°æ¯ä¸ª VM å¹¶æˆä¸ºæ ¹ï¼š sudo su - ï¼ˆå¦‚æœæ‚¨å°šæœªä»¥æ ¹èº«ä»½ç™»å½•ï¼‰ã€‚å¦‚æœè¦å¤åˆ¶å’Œç²˜è´´ï¼Œè¯·ç¡®ä¿æ¯ä¸ªå‘½ä»¤çš„å¼€å¤´ä¸åŒ…å« # ã€‚

## **é…ç½®è™šæ‹Ÿæœº**

åœ¨ä¸‰å°æœºå™¨ä¸Šï¼ˆé›†ç¾¤ä¸­çš„æ¯ä¸€å°æœºå™¨ä¸Šï¼‰æ‰§è¡Œä¸‹é¢æ‰€æœ‰çš„æ“ä½œ.

å®‰è£… vim å¹¶æ›´æ–°ç³»ç»Ÿ:

``` shell
# dnf install -y vim
# dnf update -y
```

åœ¨/etc/hosts  ä¸­æ·»åŠ ä¸»æœºæ˜å’Œ IPåœ°å€çš„æ˜ å°„ (ç”¨ä½ å®é™…çš„åŸŸåä»£æ›¿ example.com ):

``` shell
# echo "11.11.11.11 node-1.example.com" >> /etc/hosts # 11.11.11.11 is the private IP of node 1
# echo "22.22.22.22 node-2.example.com" >> /etc/hosts # 22.22.22.22 is the private IP of node 2
# echo "33.33.33.33 node-3.example.com" >> /etc/hosts # 33.33.33.33 is the private IP of node 3
```

é‡å¯ if the kernel was upgraded when running dnf update -y:

```shell
# reboot
```

å¢åŠ  Docker CE repository:

``` shell
# dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo

```

å®‰è£… Docker, containerd å’Œ Docker Compose:

``` shell
# dnf install -y docker-ce docker-ce-cli containerd.io docker-compose
```

æ¿€æ´»å¹¶å¯åŠ¨ Docker æœåŠ¡

```shell
# systemctl enable --now docker
```

## é…ç½®Docker Swarm ç®¡ç†èŠ‚ç‚¹

åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸‹é¢çš„æ“ä½œ

åˆå§‹åŒ–  Docker Swarm é›†ç¾¤ ç”¨ä½ ç®¡ç†èŠ‚ç‚¹(master node)çš„IPåœ°å€æ›¿æ¢ 11.11.11.11:

``` shell
# docker swarm init --advertise-addr 11.11.11.11
```

ç³»ç»Ÿä¼šè¿”å›ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºä¿¡æ¯: docker swarm join --token [...]. å¤åˆ¶å¹¶ä¿å­˜å®ƒ. æˆ‘ä»¬åœ¨å…¶ä»–å·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„æ—¶å€™ä¼šç”¨åˆ°å®ƒ.

ä¸ºTraefik åˆ›å»ºä¸€ä¸ª internal ç½‘ç»œ for Traefik.

``` shell
# docker network create --scope=swarm --driver=overlay proxy
```

å®‰è£… Traefik å¹¶ é…ç½® Letâ€™s Encrypt

The following should be run only on the manager.

Make a directory to store the required files:

``` shell
# mkdir -p /var/swarm/traefik
```

å®‰è£… ä½¿ç”¨ htpasswd éœ€è¦çš„ httpd-tools :

``` shell
# dnf install -y httpd-tools
```

ä¸º Traefik web ç•Œé¢(ä½¿ç”¨admin ä½œä¸ºç”¨æˆ·å)åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„HTTPè®¤è¯æ–‡ä»¶ (.htpasswd) :

``` shell
# htpasswd -c /var/swarm/traefik/.htpasswd admin
# chmod 0600 /var/swarm/traefik/.htpasswd

```

Create the Traefik configuration file (traefik.toml):

``` shell
# vim /var/swarm/traefik/traefik.toml
```

It should look like the configuration below. Copy and paste it, replacing example.com with your domain and admin@example.com with your email address (email address will be used to generate your Letâ€™s Encrypt certificates using the ACME protocol).

``` toml

logLevel = "DEBUG"
InsecureSkipVerify = true
defaultEntryPoints = ["https", "http"]

[traefikLog]
filePath = "/traefik.log"

[accessLog]
filePath = "/access.log"

[entryPoints]
  [entryPoints.http]
  address = ":80"
    [entryPoints.http.redirect]
    entryPoint = "https"
  [entryPoints.https]
  address = ":443"
    [entryPoints.https.tls]

[api]
  entryPoint = "traefik"
  dashboard = true
  address = ":8080"

[file]
  watch = true
  filename = "/rules.toml"

[acme]
email = "admin@example.com"
storage = "acme.json"
entryPoint = "https"
onDemand = false
acmeLogging = true
[acme.dnsChallenge]
  provider = "digitalocean"
  delayBeforeCheck = 0
[[acme.domains]]
  main = "*.example.com"
  sans = ["example.com"]

[docker]
domain = "example.com"
watch = true
swarmMode = true
network = "proxy"

```

æœ€å¥½çš„è¿æ°”ä¸GitLabå’Œä½ çš„DockerSwarmé›†ç¾¤ï¼ğŸ˜€ ğŸ˜Š

-------
