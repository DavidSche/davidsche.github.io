# Docker 最佳实践系列  HA PostgreSQL服务

-----

## 在docker swarm环境中部署 HA PostgreSQL服务

H/A PostgreSQL Cluster on Docker Swarm

 英文原文: <https://github.com/olgac/consul>

### 1. 准备工作

获取部署文件

``` yml
version: '3'

services:
  postgresql-master:
    image: 'bitnami/postgresql:10.7.0'
    ports:
      - '5432:5432'
    volumes:
      - 'ps_data:/bitnami'
    environment:
      - POSTGRESQL_REPLICATION_MODE=master
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=repl_password
      - POSTGRESQL_USERNAME=my_user
      - POSTGRESQL_PASSWORD=my_password
      - POSTGRESQL_DATABASE=my_database

  postgresql-slave:
    image: 'bitnami/postgresql:10.7.0'
    ports:
      - '5433:5432'
    depends_on:
      - postgresql-master
    environment:
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=repl_password
      - POSTGRESQL_MASTER_HOST=postgresql-master
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
    volumes:
      - 'ps_data1:/bitnami'

volumes:
  ps_data:
  ps_data1:

```

自定义同步策略

``` yml
version: '3.4'

services:
  postgresql-master:
    image: 'bitnami/postgresql:10.7.0'
    ports:
      - '5432'
    volumes:
      - 'postgresql_master_data:/bitnami'
    environment:
      - POSTGRESQL_REPLICATION_MODE=master
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=repl_password
      - POSTGRESQL_USERNAME=my_user
      - POSTGRESQL_PASSWORD=my_password
      - POSTGRESQL_DATABASE=my_database
#     同步策略 POSTGRESQL_SYNCHRONOUS_COMMIT_MODE  on(默认), remote_apply, remote_write, local and off.  POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS 不能大于同步数量
      - POSTGRESQL_SYNCHRONOUS_COMMIT_MODE=on
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
    volumes:
      - 'ps_data:/bitnami'
  postgresql-slave:
    image: 'bitnami/postgresql:10.7.0'
    ports:
      - '5432'
    depends_on:
      - postgresql-master
    environment:
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=repl_password
      - POSTGRESQL_MASTER_HOST=postgresql-master
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
    volumes:
      - 'ps_data1:/bitnami'
postgresql-slave2:
    image: 'bitnami/postgresql:10.7.0'
    ports:
      - '5432'
    depends_on:
      - postgresql-master
    environment:
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=repl_password
      - POSTGRESQL_MASTER_HOST=postgresql-master
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
    volumes:
      - 'ps_data2:/bitnami'

volumes:
  ps_data:
  ps_data1:
  ps_data2:
```

### 2. 部署

使用部署命令或portainer 部署

``` bash
docker stack deploy -c postgresql.yml PostgreSQL  
```

### 3. bitnami PostgreSQL 配置文件信息

Initializing a new instance
When the container is executed for the first time, it will execute the files with extensions .sh, .sql and .sql.gz located at /docker-entrypoint-initdb.d

配置文件信息

镜像使用的数据库配置文件 postgresql.conf file 位于 /opt/bitnami/postgresql/conf/. 你可以挂载存储卷 /bitnami/postgresql/conf/ 然后 复制/编辑  /path/to/postgresql-persistence/conf/ 中的 postgresql.conf 文件. 如果为空默认配置文件在 conf/ directory .

/path/to/postgresql-persistence/conf/
└── postgresql.conf

mkdir -p /path/to/postgresql-persistence/conf/conf.d/
vi /path/to/postgresql-persistence/conf/conf.d/extended.conf

环境变量信息

| Environment   |      Variable      |  Alias |
| POSTGRESQL_USERNAME | POSTGRES_USER |
| POSTGRESQL_DATABASE | POSTGRES_DB |
| POSTGRESQL_PASSWORD | POSTGRES_PASSWORD |
| POSTGRESQL_PASSWORD_FILE | POSTGRES_PASSWORD_FILE |
| POSTGRESQL_PORT_NUMBER | POSTGRES_PORT_NUMBER |
| POSTGRESQL_INITDB_ARGS | POSTGRES_INITDB_ARGS |
| POSTGRESQL_INITDB_WALDIR | POSTGRES_INITDB_WALDIR |
| POSTGRESQL_DATA_DIR | PGDATA |
| POSTGRESQL_REPLICATION_USER | POSTGRES_REPLICATION_USER |
| POSTGRESQL_REPLICATION_MODE | POSTGRES_REPLICATION_MODE |
| POSTGRESQL_REPLICATION_PASSWORD | POSTGRES_REPLICATION_PASSWORD |
| POSTGRESQL_REPLICATION_PASSWORD_FILE | POSTGRES_REPLICATION_PASSWORD_FILE |
| POSTGRESQL_CLUSTER_APP_NAME | POSTGRES_CLUSTER_APP_NAME |
| POSTGRESQL_MASTER_HOST | POSTGRES_MASTER_HOST |
| POSTGRESQL_MASTER_PORT_NUMBER	| POSTGRES_MASTER_PORT_NUMBER |
| POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS | POSTGRES_NUM_SYNCHRONOUS_REPLICAS |
| POSTGRESQL_SYNCHRONOUS_COMMIT_MODE | POSTGRES_SYNCHRONOUS_COMMIT_MODE |